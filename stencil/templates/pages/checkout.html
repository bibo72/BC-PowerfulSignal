{{#partial "head"}}

{{{ checkout.checkout_head }}}
{{{ stylesheet '/assets/css/optimized-checkout.css' }}}
{{ getFontsCollection }}

<script type="text/javascript">
    window.language = {{{langJson 'optimized_checkout'}}};
</script>

<script>
    if (sessionStorage.getItem("bundleb2b_user") && sessionStorage.getItem("bundleb2b_user") != "none") {
        var fileref = document.createElement('link');
      fileref.setAttribute("rel","stylesheet");
      fileref.setAttribute("type","text/css");
    }
</script>

{{/partial}}

{{#partial "page"}}
<header class="checkoutHeader optimizedCheckout-header">
    <div class="checkoutHeader-content">
        <h1 class="is-srOnly">{{lang 'checkout.title'}}</h1>
        <h2 class="checkoutHeader-heading">
            <a class="checkoutHeader-link" href="{{urls.home}}">
                {{#if checkout.header_image}}
                    <img alt="{{settings.store_logo.title}}" class="checkoutHeader-logo" id="logoImage" src="{{ checkout.header_image }}"/>
                {{ else }}
                    <span class="header-logo-text">{{settings.store_logo.title}}</span>
                {{/if}}
            </a>
        </h2>
    </div>
</header>

{{{ checkout.checkout_content }}}

{{{ footer.scripts }}}
<script
  src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script>
    $("body").on('change', '[name="paymentProviderRadio"]', function(){
        // PO
        $("#custom_po_number_err").remove();
        $("#checkout-payment-continue-custom").hide();

        if($(this).attr("id") == "radio-cheque" && $(this).prop('checked') == true) {
            const $checkItemBody = $(this).parents(".form-checklist-item").find(".form-checklist-body");
            $checkItemBody.html(`
                <div class="form-checklist-container">
                    <div class="form-ccFields">
                        <div class="form-field--ccNumber form-field">
                        <label class="form-label optimizedCheckout-form-label" for="ccNumber">PO #</label>
                        <input type="text" id="custom_po_number" class="form-input optimizedCheckout-form-input" required/>
                        </div>
                    </div>
                </div>`);

            $("#checkout-payment-continue").hide();
            $(`<button class="button button--action button--large button--slab optimizedCheckout-buttonPrimary" id="checkout-payment-continue-custom" type="button">
                    Place Order
                </button>`).insertAfter($("#checkout-payment-continue"));

        } else {
            if($("#checkout-payment-continue-custom").length > 0) {
                $("#checkout-payment-continue-custom").remove();
            }
            $("#checkout-payment-continue").show();
        }
    });

    $("body").on('focus', '#custom_po_number', (event)=> {
        $("#custom_po_number_err").remove();
    });

    /*save po number to our databse and order*/
    $("body").on('click', '#checkout-payment-continue-custom', (event)=> {
        let can_purchase = true;

        if($("#radio-cheque").prop("checked") == true) {
            if($("#custom_po_number").length > 0 && $("#custom_po_number").val().trim() != "") {
                let poMessage = $("#custom_po_number").val() || "";
                sessionStorage.setItem("po_number", poMessage);
            } else {
                can_purchase = false;
            }
        }

        if(can_purchase) {
            $("#checkout-payment-continue").click();
        } else {
            $("#custom_po_number_err").remove();
            $('<span id="custom_po_number_err" style="display:block;color:red;font-size:14px;margin-top:5px;">PO # is required</span>').insertAfter($("#custom_po_number"));
        }
    });

    if(sessionStorage.getItem("company_payments")) {
        const company_payments = JSON.parse(sessionStorage.getItem("company_payments"));
        //console.log(company_payments);
        var interval = setInterval(function(){
            // hide free shipping price spend & spent
            if($("discount-banners")) {
                $("discount-banners").hide();
            }

            if($(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").length > 0) {
                clearInterval(interval);
                if (sessionStorage.getItem("bundleb2b_user") == "none") {
                    $($("#radio-instore")[0].parentNode.parentNode.parentNode).hide();
                }

                console.log("handle payment method");
                const $checkoutItems = $(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item");
                $checkoutItems.each(function(){
                    const $paymentEle = $(this).find('[name="paymentProviderRadio"]');
                    const paymentCode = $paymentEle.attr("id").replace("radio-", "");
                    let isEnabled = false;
                    for (let i = 0; i < company_payments.length; i++) {
                        if(company_payments[i].code == paymentCode) {
                            isEnabled = true;
                        }
                    }
                    if(!isEnabled) {
                        $(this).remove();
                    }
                });
                if($(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").length > 0) {
                    $(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").eq(0).find('[name="paymentProviderRadio"]').prop("checked", true);
                }

            }
        },100);


       //shipping
        var interval_shipping = setInterval(function(){
            if($(".checkout-step--shipping .checkout-form .form-checklist .form-checklist-item").length > 0) {
                clearInterval(interval_shipping);

                $('.checkout-step--shipping .checkout-form .form-checklist .form-checklist-item .shippingOption-desc:contains("Free Shipping")').parents(".form-checklist-item").remove();
            }
        },100);

    }
</script>
<script>
$(document).ready(function(){

  if(sessionStorage.getItem("bundleb2b_user") && sessionStorage.getItem("bundleb2b_user") != "none") {
    var intervalCupon = setInterval(function(){
      console.log($(".redeemable-label"));
      if($(".redeemable-label").length > 0) {
        $(".redeemable-label").remove();
        clearInterval(intervalCupon);
      }
    }, 300);
  }


  function checkForLoading(cb){
    var loadingOn = function() { return  $('.loadingNotification.ng-hide').length !== 1 };
    var onTime = Date.now();
    var interval = setInterval(function(){
      //console.log("inside Interval");

      var isLoadingOn = loadingOn();
      if (isLoadingOn) {
        onTime = Date.now();
      }

      if (!isLoadingOn && Date.now() - onTime > 400) {
        clearInterval(interval);
        setTimeout(cb, 100);
      }

      //console.log("loading icon is on",isLoadingOn);
    },100);
  }

  function hideFreeShipping(){
    if(sessionStorage.getItem("bundleb2b_user") && sessionStorage.getItem("bundleb2b_user") != "none") {

        var loadingOn = function() { return  $('.checkout-step--shipping .checkout-form .form-checklist .form-checklist-item .shippingOption-desc:contains("Free Shipping")').length };
        var timercount = 0;
        var interval = setInterval(function(){
          //console.log("inside Interval");
          timercount ++;

          var isLoadingOn = loadingOn();

          if (isLoadingOn || timercount > 50) {
            clearInterval(interval);
            const $freeShippingOption = $('.checkout-step--shipping .checkout-form .form-checklist .form-checklist-item .shippingOption-desc:contains("Free Shipping")');
                if($freeShippingOption.length > 0) {
                    $freeShippingOption.parents(".form-checklist-item").remove();

                }

          }
        },100);

    }

  }

  function handlePaymentMethod(){
    if(sessionStorage.getItem("company_payments")) {
        const company_payments = JSON.parse(sessionStorage.getItem("company_payments"));

        if($(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").length > 0) {
            const $checkoutItems = $(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item");
            $checkoutItems.each(function(){
                const $paymentEle = $(this).find('[name="paymentProviderRadio"]');
                const paymentCode = $paymentEle.attr("id").replace("radio-", "");
                let isEnabled = false;
                for (let i = 0; i < company_payments.length; i++) {
                    if(company_payments[i].code == paymentCode) {
                        isEnabled = true;
                    }
                }
                if(!isEnabled) {
                    $(this).remove();
                }
            });
            if($(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").length > 0) {
                $(".checkout-step--payment .checkout-form .form-checklist .form-checklist-item").eq(0).find('[name="paymentProviderRadio"]').prop("checked", true);
            }
        }

    }

  }

  //set timeout to wait for the angular to load
  checkForLoading(function(){
    //setTimeout(function(){
    //when page loads and form is in shipping cartSection

      var click = document.addEventListener('click',function(event){
        //console.log("partialShipStatus in click event: ", partialStatus);
        button = event.target;
        var buttonType = $(button).attr("type");
        console.log(button);

        if (buttonType === 'submit'){
          checkForLoading(function(){
            hideFreeShipping();
            handlePaymentMethod();
          });
        } else if($(button).parents("checkout-header").attr("step") == "shipping") {
            checkForLoading(function(){
                hideFreeShipping();
              });
        } else if($(button).parents("[shipping-option-item-selected-id]").length) {
            checkForLoading(function(){
                hideFreeShipping();
              });

        }

      });
    });
});
</script>

{{/partial}}

{{> layout/empty}}
